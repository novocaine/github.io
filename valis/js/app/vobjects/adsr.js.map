{"version":3,"sources":["../../../../../www/js/app/vobjects/adsr.js"],"names":[],"mappings":"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","file":"adsr.js","sourcesContent":["define(['lodash', 'app/vobjects/vobject'], (_, vobject) => {\n  class ADSREnvelope extends vobject.VObject {\n    numInputs() { return 1; }\n    numOutputs() { return 1; }\n\n    constructor(options, attack = 1, decay = 1, sustain = 0, release = 1) {\n      super(options, attack, decay, sustain, release);\n      this.attack = parseFloat(attack);\n      this.decay = parseFloat(decay);\n      this.sustain = parseFloat(sustain);\n      this.release = parseFloat(release);\n      this._triggerOn = null;\n      this._triggerOff = null;\n      this._ptr = 0;\n      this._lastOutput = 0;\n      this._outputAtTriggerOff = 0;\n      this._outputAtTriggerOn = 0;\n    }\n\n    genEnvelope(context, result, triggerOn, until, ptr) {\n      const attackSampleTime = this.attack * context.sampleRate;\n      const attackGradient = (1.0 - this._outputAtTriggerOn) / attackSampleTime;\n      const decaySampleTime = this.decay * context.sampleRate;\n      const decayGradient = (-1.0 + this.sustain) / decaySampleTime;\n      const decaySampleEnd = decaySampleTime + attackSampleTime;\n\n      // attack phase\n      let r = triggerOn - context.sampleTime;\n      if (r < 0) {\n        r = 0;\n      }\n      for (;\n          ptr < attackSampleTime && r < result.length\n            && (r + context.sampleTime) < until;\n          r++, ptr++) {\n        this._lastOutput += attackGradient;\n        result[r] = this._lastOutput;\n      }\n\n      // decay phase\n      for (;\n          ptr < decaySampleEnd && r < result.length\n            && (r + context.sampleTime) < until;\n          r++, ptr++) {\n        this._lastOutput += decayGradient;\n        result[r] = this._lastOutput;\n      }\n\n      // sustain phase\n      for (;\n          r < result.length && (r + context.sampleTime) < until;\n          r++) {\n        this._lastOutput = result[r] = this.sustain;\n      }\n\n      return ptr;\n    }\n\n    genReleaseEnvelope(context, result, triggerOff, until, ptr) {\n      const releaseSampleTime = this.release * context.sampleRate;\n      const releaseGradient = -this._outputAtTriggerOff / releaseSampleTime;\n\n      let r = triggerOff - context.sampleTime;\n      if (r < 0) {\n        r = 0;\n      }\n      for (;\n          ptr < releaseSampleTime && r < result.length\n            && (r + context.sampleTime) < until;\n          r++, ptr++) {\n        this._lastOutput += releaseGradient;\n        result[r] = this._lastOutput;\n      }\n\n      if (ptr >= releaseSampleTime) {\n        this._triggerOff = null;\n      }\n\n      return ptr;\n    }\n\n    generate(context, inputs, outputs) {\n      if (!inputs[0]) {\n        return [];\n      }\n      const result = context.getBuffer();\n\n      // finish playing envelope from messages in previous generates\n      const untilPrev = inputs[0].length ? inputs[0][0].sampleTime : Number.MAX_VALUE;\n      if (this._triggerOn) {\n        this._ptr = this.genEnvelope(context, result, this._triggerOn, untilPrev,\n          this._ptr);\n      } else if (this._triggerOff) {\n        this._ptr = this.genReleaseEnvelope(context, result, this._triggerOff, untilPrev,\n          this._ptr);\n      }\n\n      for (let i = 0; i < inputs[0].length; i++) {\n        const message = inputs[0][i];\n\n        // limit the playback of the envelope until next message\n        const until = (i === inputs[0].length - 1 ? Number.MAX_VALUE :\n          inputs[0][i + 1].sampleTime);\n\n        if (message.data) {\n          // gate on\n          this._triggerOn = message.sampleTime;\n          this._outputAtTriggerOn = this._lastOutput;\n          this._ptr = 0;\n          this._triggerOff = null;\n          this._ptr = this.genEnvelope(context, result, this._triggerOn, until,\n            this._ptr);\n          // TODO: disabling this puts the envelope into 'legato' mode, which\n          // isn't always what you want - but enabling causes pops which need\n          // to be ramped out\n          // this._lastOutput = this._lastOutput;\n        } else {\n          // gate off\n          this._ptr = 0;\n          this._triggerOn = null;\n          this._triggerOff = message.sampleTime;\n          this._outputAtTriggerOff = this._lastOutput;\n          this._ptr = this.genReleaseEnvelope(context, result, this._triggerOff, until,\n            this._ptr);\n        }\n      }\n\n      return [result];\n    }\n  }\n\n  ADSREnvelope.vobjectClass = 'adsr';\n  ADSREnvelope.vobjectSymbol = 'adsr';\n\n  return ADSREnvelope;\n});\n"]}