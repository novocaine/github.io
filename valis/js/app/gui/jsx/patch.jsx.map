{"version":3,"sources":["../../../../../../www/js/app/gui/jsx/patch.jsx"],"names":[],"mappings":"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","file":"patch.jsx","sourcesContent":["define(['lib/react',\n        'lib/lodash',\n        'app/gui/jsx/vobjects/simple',\n        'app/vobject_factory',\n        'lib/jquery'],\n(React, _, simple, vobjectFactory, $) => {\n  const PatchComponent = React.createClass({\n    propTypes: {\n      patchModel: React.PropTypes.object.isRequired\n    },\n\n    render: () => {\n      return (\n        <div className=\"patch\">\n          <div className=\"vobjects\">\n            {\n              _.mapValues(this.props.patchModel.graph.vobjects, (vobject) => {\n                return this.renderVObject(this.props.patchModel, vobject);\n              }, this)\n            }\n          </div>\n          <svg>\n            <DrawingDedgeLine ref=\"drawingDedgeLine\" />\n            {\n              _.bind(() => {\n                const result = [];\n                this.props.patchModel.graph.iterDedges(_.bind((dedge) => {\n                  result.push(\n                    <DEdge dedge={dedge} patchModel={this.props.patchModel}\n                      patchComponent={this} />);\n                }, this));\n                return result;\n              }, this)()\n            }\n          </svg>\n        </div>\n      );\n    },\n\n    renderVObject: (patchModel, vobject) => {\n      return (\n        <simple.SimpleVObjectComponent\n          vobject={vobject}\n          key={vobject.id}\n          patchModel={patchModel}\n          patchComponent={this} />\n      );\n    },\n\n    componentDidMount: () => {\n      $(this.getDOMNode()).droppable({\n        accept: '.palette-item',\n        drop: _.bind((event, ui) => {\n          const vobject = vobjectFactory.create(ui.helper.attr('data-classname'));\n          const domNode = $(this.getDOMNode());\n          const offset = domNode.offset();\n          this.props.patchModel.addVobject(vobject,\n            ui.position.left - offset.left,\n            ui.position.top - offset.top);\n          // trigger re-render\n          this.setState({});\n        }, this)\n      });\n    },\n\n    startDrawingDedge: (fromVobjectComponent, fromOutputNum, clientX, clientY) => {\n      const line = this.refs.drawingDedgeLine;\n\n      // convert clientX, clientY from window co-ordinates to patch\n      // co-ordinates\n      const domNode = $(this.getDOMNode());\n      const offset = domNode.offset();\n      const startX = clientX - offset.left;\n      const startY = clientY - offset.top;\n\n      // attach patch-wide mousemove\n      domNode.on('mousemove', (emm) => {\n        line.setState({\n          startX,\n          startY,\n          drawToX: emm.clientX - offset.left,\n          drawToY: emm.clientY - offset.top,\n          visible: true\n        });\n        return false;\n      });\n\n      domNode.one('mouseup', _.bind((e) => {\n        domNode.off('mousemove');\n        line.setState({\n          visible: false\n        });\n\n        // dropped on an input?\n        const elem = $(document.elementFromPoint(e.clientX, e.clientY));\n        if (!elem.length) {\n          return;\n        }\n\n        const input = elem.closest('[data-input-index]');\n        if (!input.length) {\n          return;\n        }\n\n        const vobjectElem = elem.closest('[data-vobject-id]');\n        if (!vobjectElem.length) {\n          return;\n        }\n\n        const toVobject = this.props.patchModel.graph.vobjects[\n          parseInt(vobjectElem.attr('data-vobject-id'), 10)];\n        const toInput = parseInt(input.attr('data-input-index'), 10);\n\n        this.props.patchModel.graph.addDedge(\n          fromVobjectComponent.props.vobject,\n          fromOutputNum,\n          toVobject,\n          toInput);\n        this.setState({});\n      }, this));\n    },\n\n    updateVobject: (vobjectComponent) => {\n      // redraw the edges attached to this vobject (maybe it moved)\n      // XXX for now ..\n      this.forceUpdate();\n    }\n  });\n\n  /**\n   * The line being drawn while user draws a new dedge\n   */\n  const DrawingDedgeLine = React.createClass({\n    getInitialState: () => {\n      return { visible: false };\n    },\n\n    render: () => {\n      const style = {\n        visibility: this.state.visible ? 'visible' : 'hidden',\n        strokeWidth: 1,\n        stroke: 'rgb(0, 0, 0)'\n      };\n\n      return (<line x1={this.state.startX}\n        y1={this.state.startY}\n        x2={this.state.drawToX}\n        y2={this.state.drawToY}\n        style={style} />);\n    }\n  });\n\n  const DEdge = React.createClass({\n    // hard-coded sizing metrics to avoid having to do lookups against the\n    // live elements. TODO - maybe we could look this up once then cache them?\n    statics: {\n      outputX_padding: 30,\n      inputX_padding: 30\n    },\n\n    propTypes: {\n      dedge: React.PropTypes.object.isRequired,\n      patchModel: React.PropTypes.object.isRequired,\n      patchComponent: React.PropTypes.object.isRequired\n    },\n\n    render: () => {\n      // calculate tail pos\n      const vobjectFrom = this.props.dedge.from;\n      const vobjectFromPos = this.props.patchModel.vobjectPositions[\n        vobjectFrom.id];\n\n      const vobjectFromElem = simple.findVobjectElem(vobjectFrom.id);\n      const tailPos = {\n        x: vobjectFromPos.x + this.props.dedge.fromOutput * DEdge.outputX_padding,\n        y: vobjectFromPos.y + vobjectFromElem.height()\n      };\n\n      // calculate arrow pos\n      const vobjectTo = this.props.dedge.to;\n      const vobjectToPos = this.props.patchModel.vobjectPositions[\n        vobjectTo.id];\n\n      const arrowPos = {\n        x: vobjectToPos.x + this.props.dedge.toInput * DEdge.inputX_padding,\n        y: vobjectToPos.y\n      };\n\n      return (\n        <line className=\"dedge\" x1={tailPos.x}\n          y1={tailPos.y}\n          x2={arrowPos.x}\n          y2={arrowPos.y}\n          onClick={this.onClick}/>\n      );\n    },\n\n    onClick: () => {\n      // delete\n      this.props.patchModel.graph.removeDedge(\n        this.props.dedge.from,\n        this.props.dedge.fromOutput,\n        this.props.dedge.to,\n        this.props.dedge.toInput);\n\n      this.props.patchComponent.forceUpdate();\n    }\n  });\n\n  return { PatchComponent };\n});\n"]}