{"version":3,"sources":["../../../../../../www/js/app/gui/jsx/patch.js"],"names":[],"mappings":"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","file":"patch.js","sourcesContent":["define(['react',\n        'react-dom',\n        'lodash',\n        'app/gui/jsx/vobjects/simple',\n        'app/vobject_factory',\n        'jquery'],\n(React, ReactDOM, _, simple, vobjectFactory, $) => {\n  const PatchComponent = React.createClass({\n    propTypes: {\n      patchModel: React.PropTypes.object.isRequired\n    },\n\n    render() {\n      return (\n        <div className=\"patch\">\n          <div className=\"vobjects\">\n            {\n              _.map(this.props.patchModel.graph.vobjects, (vobject) =>\n                <simple.SimpleVObjectComponent\n                  vobject={vobject}\n                  key={vobject.id}\n                  patchModel={this.props.patchModel}\n                  patchComponent={this} />\n              )\n            }\n          </div>\n          <svg>\n            <DrawingDedgeLine ref=\"drawingDedgeLine\" />\n            {\n                _.map(this.props.patchModel.graph.getAllDedges(), (dedge) =>\n                    <DEdge dedge={dedge} patchModel={this.props.patchModel}\n                      patchComponent={this} key={dedge.id()} />\n                )\n            }\n          </svg>\n        </div>\n      );\n    },\n\n    componentDidMount() {\n      $(ReactDOM.findDOMNode(this)).droppable({\n        accept: '.palette-item',\n        drop: (event, ui) => {\n          const vobject = this.props.patchModel.vobjectFactory.create(\n            ui.helper.attr('data-classname'));\n          const domNode = $(ReactDOM.findDOMNode(this));\n          const offset = domNode.offset();\n          this.props.patchModel.addVobject(vobject,\n            ui.position.left - offset.left,\n            ui.position.top - offset.top);\n          // trigger re-render\n          this.setState({});\n          // focus args of the new object, XXX: seems to break into react's dom\n          $(`[data-vobject-id=${vobject.id}] textarea`).focus();\n        }\n      });\n    },\n\n    startDrawingDedge(fromVobjectComponent, fromOutputNum, clientX, clientY) {\n      const line = this.refs.drawingDedgeLine;\n\n      // convert clientX, clientY from window co-ordinates to patch\n      // co-ordinates\n      const domNode = $(ReactDOM.findDOMNode(this));\n      const offset = domNode.offset();\n      const startX = clientX - offset.left;\n      const startY = clientY - offset.top;\n\n      // attach patch-wide mousemove\n      domNode.on('mousemove', (emm) => {\n        line.setState({\n          startX,\n          startY,\n          drawToX: emm.clientX - offset.left,\n          drawToY: emm.clientY - offset.top,\n          visible: true\n        });\n        return false;\n      });\n\n      domNode.one('mouseup', (e) => {\n        domNode.off('mousemove');\n        line.setState({\n          visible: false\n        });\n\n        // dropped on an input?\n        const elem = $(document.elementFromPoint(e.clientX, e.clientY));\n        if (!elem.length) {\n          return;\n        }\n\n        const input = elem.closest('[data-input-index]');\n        if (!input.length) {\n          return;\n        }\n\n        const vobjectElem = elem.closest('[data-vobject-id]');\n        if (!vobjectElem.length) {\n          return;\n        }\n\n        const toVobject = this.props.patchModel.graph.vobjects[\n          parseInt(vobjectElem.attr('data-vobject-id'), 10)];\n        const toInput = parseInt(input.attr('data-input-index'), 10);\n\n        this.props.patchModel.graph.addDedge(\n          fromVobjectComponent.props.vobject,\n          fromOutputNum,\n          toVobject,\n          toInput);\n        this.setState({});\n      });\n    },\n\n    updateVobject(vobjectComponent) {\n      // redraw the edges attached to this vobject (maybe it moved)\n      // XXX for now ..\n      this.forceUpdate();\n    }\n  });\n\n  /**\n   * The line being drawn while user draws a new dedge\n   */\n  const DrawingDedgeLine = React.createClass({\n    getInitialState() {\n      return { visible: false };\n    },\n\n    render() {\n      const style = {\n        visibility: this.state.visible ? 'visible' : 'hidden',\n        strokeWidth: 1,\n        stroke: 'rgb(0, 0, 0)'\n      };\n\n      return (<line x1={this.state.startX}\n        y1={this.state.startY}\n        x2={this.state.drawToX}\n        y2={this.state.drawToY}\n        style={style} />);\n    }\n  });\n\n  const DEdge = React.createClass({\n    // hard-coded sizing metrics to avoid having to do lookups against the\n    // live elements. TODO - maybe we could look this up once then cache them?\n    statics: {\n      outputXPadding: 30,\n      outputXLeftMargin: 28,\n      inputXPadding: 30,\n      inputXLeftMargin: 28,\n      vobjectHeight: 44\n    },\n\n    propTypes: {\n      dedge: React.PropTypes.object.isRequired,\n      patchModel: React.PropTypes.object.isRequired,\n      patchComponent: React.PropTypes.object.isRequired\n    },\n\n    render() {\n      // calculate tail pos\n      const vobjectFrom = this.props.dedge.from;\n      const vobjectFromPos = this.props.patchModel.vobjectPositions[\n        vobjectFrom.id];\n\n      const tailPos = {\n        x: vobjectFromPos.x + DEdge.outputXLeftMargin + (\n          this.props.dedge.fromOutput * DEdge.outputXPadding),\n        y: vobjectFromPos.y + DEdge.vobjectHeight\n      };\n\n      // calculate arrow pos\n      const vobjectTo = this.props.dedge.to;\n      const vobjectToPos = this.props.patchModel.vobjectPositions[\n        vobjectTo.id];\n\n      const arrowPos = {\n        x: vobjectToPos.x + DEdge.inputXLeftMargin + (\n          this.props.dedge.toInput * DEdge.inputXPadding),\n        y: vobjectToPos.y\n      };\n\n      return (\n        <line className=\"dedge\" x1={tailPos.x}\n          y1={tailPos.y}\n          x2={arrowPos.x}\n          y2={arrowPos.y}\n          onClick={this.onClick}/>\n      );\n    },\n\n    onClick() {\n      // delete\n      this.props.patchModel.graph.removeDedge(\n        this.props.dedge.from,\n        this.props.dedge.fromOutput,\n        this.props.dedge.to,\n        this.props.dedge.toInput);\n\n      this.props.patchComponent.forceUpdate();\n    }\n  });\n\n  return { PatchComponent };\n});\n"]}