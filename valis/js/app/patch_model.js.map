{"version":3,"sources":["../../../../www/js/app/patch_model.js"],"names":[],"mappings":"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","file":"patch_model.js","sourcesContent":["define(['app/engine', 'lodash', 'app/vobject_factory'],\n(engine, _, VObjectFactory) => {\n  class PatchModel {\n    constructor(patchJSON) {\n      // TODO: move this into a parent 'doc' when we support sub-patches\n      this.engine = new engine.Engine();\n      this.graph = this.engine.graph;\n\n      if (!patchJSON) {\n        // new blank document\n        this.vobjectPositions = {};\n        this.vobjectFactory = new VObjectFactory(0);\n      } else {\n        const json = _.isString(patchJSON) ? JSON.parse(patchJSON) : patchJSON;\n        this.vobjectPositions = json.vobjectPositions;\n        this.vobjectFactory = new VObjectFactory(json.nextVobjectId);\n\n        _.each(json.vobjects, (vobjectDesc, id) => {\n          const vobject = this.vobjectFactory.create(vobjectDesc.vobjectClass,\n            id, ...vobjectDesc.args);\n          this.graph.addVobject(vobject);\n        });\n\n        _.each(json.dedges, (dedgeDesc) => {\n          this.graph.addDedge(this.graph.vobjects[dedgeDesc.from],\n            dedgeDesc.fromOutput,\n            this.graph.vobjects[dedgeDesc.to],\n            dedgeDesc.toInput);\n        });\n      }\n    }\n\n    addVobject(vobject, x, y) {\n      // add to underlying graph\n      this.graph.addVobject(vobject);\n      this.vobjectPositions[vobject.id] = { x, y };\n    }\n\n    updateVobjectArgs(vobject, args) {\n      // delete and re-instantiate the object with new arguments\n      const newVobject = this.vobjectFactory.create(\n        vobject.constructor.vobjectClass, null, ...args);\n      this.graph.replaceVobject(vobject, newVobject);\n      this.vobjectPositions[newVobject.id] = this.vobjectPositions[vobject.id];\n      delete this.vobjectPositions[vobject.id];\n    }\n\n    // keep positions and sizes of vobjects up to date here after each render\n    // for fast access when rendering dedges (otherwise the dedge renderer\n    // would have to measure the items every time, which is slow)\n\n    setVobjectPosition(vobjectId, x, y) {\n      this.vobjectPositions[vobjectId] = { x, y };\n    }\n\n    getVobjectPosition(vobjectId) {\n      return this.vobjectPositions[vobjectId];\n    }\n\n    enableAudio(enabled = true) {\n      enabled ? this.engine.start() : this.engine.stop();\n    }\n\n    audioEnabled() {\n      return this.engine.running;\n    }\n\n    toJSON() {\n      const dedges = _.map(this.engine.graph.getAllDedges(), (dedge) => {\n        return {\n          from: dedge.from.id,\n          fromOutput: dedge.fromOutput,\n          to: dedge.to.id,\n          toInput: dedge.toInput\n        };\n      });\n\n      const vobjects = _.reduce(this.engine.graph.vobjects, (memo, vobject) => {\n        memo[vobject.id] = {\n          vobjectClass: vobject.constructor.vobjectClass,\n          args: vobject.args\n        };\n        return memo;\n      }, {});\n\n      return { dedges, vobjects, vobjectPositions: this.vobjectPositions,\n        nextVobjectId: this.vobjectFactory.nextId };\n    }\n  }\n\n  return PatchModel;\n});\n"]}